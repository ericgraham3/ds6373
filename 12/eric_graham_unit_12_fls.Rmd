---
title: "Unit 12 FLS"
author: "Eric Graham"
date: "`r Sys.Date()`"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tswge)
library(vars)
library(astsa)

cmort = read.csv("la_cmort_study.csv")
biz = read.csv("BusinessSales.csv")
```

# Part 1: Pollution and Temperature Impact on Cardiac Mortality

## EDA

```{r, results='hide'}
plotts.sample.wge(cmort$cmort)
plotts.sample.wge(cmort$part)
plotts.sample.wge(cmort$temp)
```

Here we see that all three variables have clear seasonal patterns with dampening sinusoidal autocorrelations and what appears to be a 52-week cyclic effect. The cardiac mortality and particulate pollution series also show slight upward trends over time.

## Seasonal Differencing

```{r, results='hide'}
part_52 = artrans.wge(cmort$part, c(rep(0,51),1))
plotts.sample.wge(part_52)
aic5.wge(part_52)
ljung.wge(part_52, K = 48)$pval

temp_52 = artrans.wge(cmort$temp, c(rep(0,51),1))
plotts.sample.wge(temp_52)
aic5.wge(temp_52)
ljung.wge(temp_52, K = 48)$pval

predsPart = fore.aruma.wge(cmort$part, s = 52, n.ahead = 52)
predsTemp = fore.aruma.wge(cmort$temp, s = 52, n.ahead = 52)
```

After seasonal differencing, AIC selects an ARMA(0,0). Particulates pass the white noise tests (p=0.22) while temperature is borderline (p=0.03), which indicates that we can implement seasonal forecasts with no additional arma model. We forecast the next 52 weeks of both features for later use.

## MLR with ARIMA Errors Model

```{r, results='hide'}
cmort_train = cmort[1:456,]

ksfit = lm(cmort~temp+part, data = cmort_train)
phi = aic.wge(ksfit$residuals)
fit1 = arima(cmort_train$cmort, order = c(phi$p,0,0), seasonal = list(order = c(0,1,0), period = 52), xreg = cbind(cmort_train$temp, cmort_train$part))
AIC(fit1)
ljung.wge(fit1$residuals, K = 48)$pval

preds1 = predict(fit1, newxreg = cbind(cmort$temp[457:508], cmort$part[457:508]))
ASE1 = mean((cmort$cmort[457:508] - preds1$pred)^2)
ASE1

plot(seq(1,508,1), cmort$cmort, type = "l", xlim = c(0,508), ylab = "Cardiac Mortality", main = "MLR ARIMA")
lines(seq(457,508,1), preds1$pred, type = "l", col = "red")

```

We fit an MLR-ARIMA(2,0,1) model with seasonal differencing (s=52) which achieves AIC=2753 and ASE=172.18, but residuals fail white noise tests (p=0.0009).

## Fitting VAR Model

```{r, results='hide'}
VARselect(cbind(cmort_train$cmort, cmort_train$part, cmort_train$temp), lag.max = 10, season = 52, type = "both")

fit2 = VAR(cbind(cmort_train$cmort, cmort_train$part, cmort_train$temp), season = 52, type = "both", p = 2)
preds2 = predict(fit2, n.ahead = 52)
ASE2 = mean((cmort$cmort[457:508] - preds2$fcst$y1[,1])^2)
ASE2
```

As an alternative approach, we fit a VAR model. VARselect's optimal lag order recommends p=2 and the VAR(2) model with seasonal dummies achieves ASE=40.30, which outperforms the MLR-ARIMA approach (ASE=172.18).

## Forecasting VAR

```{r, results='hide'}
ksfit_full = lm(cmort~temp+part, data = cmort)
phi_full = aic.wge(ksfit_full$residuals)
fit_final = arima(cmort$cmort, order = c(phi_full$p,0,0), seasonal = list(order = c(0,1,0), period = 52), xreg = cbind(cmort$temp, cmort$part))
AIC(fit_final)
ljung.wge(fit_final$residuals, K = 48)$pval

next52 = data.frame(temp = predsTemp$f, part = predsPart$f)
preds_final = predict(fit_final, newxreg = next52)

plot(seq(1,508,1), cmort$cmort, type = "l", xlim = c(0,560), ylab = "Cardiac Mortality", main = "52 Week Cardiac Mortality Forecast")
lines(seq(509,560,1), preds_final$pred, type = "l", col = "red")
```

The final MLR-ARIMA(2,0,1) model with seasonal differencing forecasts cardiac mortality using forecasted explanatory variables, achieving AIC=3095 (though residuals still fail white noise tests, p=0.0036).

# Part 2: ASE for Business Sales Forecasting

##

```{r, include=FALSE}
# UNIT 12 R Code

### MLR Modeling

library(tswge)
# Model 1

#Assuming a data.frame exists with corresponding names below.
BSales = read.csv("BusinessSales.csv", header = TRUE)

# All data with no lag and no trend
ksfit=lm(sales~ad_tv+ad_online+discount, data = BSales)
AIC(ksfit)#468
summary(ksfit)

aic.wge(ksfit$residuals,p=0:8, q=0)  # AIC picks p=7
fit=arima(BSales$sales,order=c(4,0,2),xreg=BSales[,3:5])
fit
AIC(fit) #342.624

acf(fit$residuals)
ltest = ljung.wge(fit$resid)
ltest$pval

# ASE for model with no lag and no trend (last 5)
BSales2 = BSales[1:95,]
ksfit=lm(sales~ad_tv+ad_online+discount, data = BSales2)
AIC(ksfit)

aic.wge(ksfit$residuals,p=0:8, q=0)  # AIC picks p=7
fit=arima(BSales2$sales,order=c(7,0,0),xreg=cbind(BSales2$ad_tv,BSales2$ad_online,BSales2$discount))
fit
AIC(fit) #331.2908

preds = predict(fit, newxreg = cbind(BSales$ad_tv[96:100],BSales$ad_online[96:100],BSales$discount[96:100]))
ASE1 = mean((BSales$sales[96:100] - preds$pred)^2)
ASE1

dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$pred, type = "l", col = "red")





# Model 2

#with trend

# ASE for model with no lag and trend (last 5)
t=1:100
BSales$t = t
BSales2 = BSales[1:95,]
ksfit=lm(sales~t+ad_tv+ad_online+discount, data = BSales2)
AIC(ksfit) #436.5708

aic.wge(ksfit$residuals,p=0:8, q=0)  # AIC picks p=7
fit=arima(BSales2$sales,order=c(7,0,0),xreg=cbind(BSales2$ad_tv,BSales2$ad_online,BSales2$t,BSales2$discount))
fit
AIC(fit) #323.8653

preds = predict(fit, newxreg = cbind(BSales$ad_tv[96:100],BSales$ad_online[96:100],BSales$t[96:100],BSales$discount[96:100]))
ASE2 = mean((BSales$sales[96:100] - preds$pred)^2)
ASE2 #62.89

dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$pred, type = "l", col = "red")





#Lagging Variables
#Example:
#With dplyr lag function
library(dplyr)
df = data.frame(Y = c(1,1,2,3,4,4,5,8),X1 = c(5,6,6,7,7,8,8,9))
df$X1_L1 = dplyr::lag(df$X1,1)
df$X1_L2 = dplyr::lag(df$X1,2)
df




# Model 3

#Lagging BSales Ad Variables
ccf(BSales$ad_tv,BSales$sales)
ccf(BSales$sales,BSales$ad_tv)
ad_tv1 = dplyr::lag(BSales$ad_tv,1)
ccf(BSales$ad_online,BSales$sales)
ad_online1 = dplyr::lag(BSales$ad_online,1)
BSales$ad_tv1= ad_tv1
BSales$ad_online1 = ad_online1


#with trend and lagging

# ASE for model with no lag and trend (last 5)
t=1:100
BSales$t = t
BSales2 = BSales[2:95,]
ksfit=lm(sales~t+ad_tv1+ad_online1+discount, data = BSales2)
AIC(ksfit) #342.4204

aic5.wge(ksfit$residuals,p=0:8,q=0:6)  # AIC picks p=7
fit = arima(BSales2$sales,order = c(7,0,0), xreg = cbind(BSales2$ad_tv1,BSales2$ad_online1,BSales2$t,BSales2$discount))
fit
AIC(fit) #332.4592

preds = predict(fit, newxreg = cbind(BSales$ad_tv1[96:100],BSales$ad_online1[96:100],BSales$t[96:100],BSales$discount[96:100]))
ASE3 = mean((BSales$sales[96:100] - preds$pred)^2)
ASE3 #4.933711


dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$pred, type = "l", col = "red")











####### Forecast Features 

plotts.sample.wge(BSales$ad_tv)
ests = aic.wge(BSales$ad_tv)
est_ad_tv = est.arma.wge(BSales$ad_tv,p = 2, q = 2)
ad_tvFORECAST = fore.arma.wge(BSales$ad_tv,phi = est_ad_tv$phi, theta = est_ad_tv$theta, n.ahead = 20)

plotts.sample.wge(BSales$ad_online)
aic5.wge(BSales$ad_online, p = 0:10)
est_online = est.arma.wge(BSales$ad_online,p = 6)
dev.off()
plot.ts(BSales$ad_online[1:100])
ad_onlineFORECAST = fore.arma.wge(BSales$ad_online,phi = est_online$phi, n.ahead = 6)



#with trend and lagging

ad_tvFORECAST1 = lag(ad_tvFORECAST,1)

ad_onlineFORECAST1 = lag(ad_onlineFORECAST,1)

# ASE for model with no lag and trend (last 5) with what you would really know... forecast explanoatory variables.  
t=1:100
BSales$t = t
BSales2 = BSales[2:95,]
ksfit=lm(sales~t+ad_tv1+ad_online1, data = BSales2)
aic.wge(ksfit$residuals,p=0:8,q=0:0)  # AIC picks p=7
fit = arima(BSales2$sales,order = c(7,0,0), xreg = cbind(BSales2$ad_tv1,BSales2$ad_online1,BSales2$t))
fit
AIC(fit) #332.94

preds = predict(fit, newxreg = cbind(ad_tvFORECAST$f[1:5],ad_onlineFORECAST$f[1:5],BSales$t[96:100]))
ASE3.5 = mean((BSales$sales[96:100] - preds$pred[1:5])^2)
ASE3.5 #13.06587


plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$pred[2:6], type = "l", col = "red")








############ VAR MODELS ##########################

#Model 4

BSVar1 = VAR(cbind(BSales2$sales,BSales2$ad_tv,BSales2$ad_online), type = "both", lag.max = 10)
AIC(BSVar1)

preds = predict(BSVar1,n.ahead = 5)
                  
ASE4 = mean((BSales$sales[96:100] - preds$fcst$y1[,1])^2)
ASE4 #21.4465


dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$fcst$y1[,1], type = "l", col = "red")


#Model 5   ... No trend so since the data take an unexpected dip, the ASE will be better ... but AIC is better overall because there is evidence of a trend. 
BSVar = VAR(cbind(BSales2$sales,BSales2$ad_tv,BSales2$ad_online), type = "const", lag.max = 10)
AIC(BSVar)

preds = predict(BSVar,n.ahead = 5)

ASE5 = mean((BSales$sales[96:100] - preds$fcst$y1[,1])^2)
ASE5 #11.49

dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$fcst$y1[,1], type = "l", col = "red")


#Model 6 ... trying to get at trend
time = data.frame(time = seq(1,94,1))
BSVar = VAR(cbind(BSales2$sales,BSales2$ad_tv,BSales2$ad_online), type = "const", lag.max = 10,exogen = time)
AIC(BSVar) #169.7788

time = data.frame(time = seq(1,94,1))
BSVar = VAR(cbind(BSales2$sales,BSales2$ad_tv,BSales2$ad_online), type = "both", lag.max = 10)
AIC(BSVar)


preds = predict(BSVar,n.ahead = 5)

ASE5 = mean((BSales$sales[96:100] - preds$fcst$y1[,1])^2)
ASE5 #21.44551

dev.off()
plot(seq(1,100,1), BSales$sales[1:100], type = "l",xlim = c(0,100), ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$fcst$y1[,1], type = "l", col = "red")

```

## Model Comparisons

```{r, include=FALSE}
library(dplyr)
BSales2 = BSales[1:95,]

```

In the async we fit six models to the business sales data: three MLR-ARIMA models and three VAR models. I selected two to forecast the last five weeks of sale: MLR-ARIMA Model 3 and VAR Model 5. Both models will be trained on weeks 1-95 and tested on weeks 96-100.

## MLR-ARIMA Model 3

```{r, results='hide'}
t = 1:100
BSales$t = t
ad_tv1 = dplyr::lag(BSales$ad_tv, 1)
ad_online1 = dplyr::lag(BSales$ad_online, 1)
BSales$ad_tv1 = ad_tv1
BSales$ad_online1 = ad_online1

BSales2 = BSales[2:95,]
ksfit = lm(sales~t+ad_tv1+ad_online1+discount, data = BSales2)
aic5.wge(ksfit$residuals, p=0:8, q=0:6)

fit = arima(BSales2$sales, order = c(7,0,0), 
            xreg = cbind(BSales2$ad_tv1, BSales2$ad_online1, 
                         BSales2$t, BSales2$discount))
AIC(fit)

preds = predict(fit, newxreg = cbind(BSales$ad_tv1[96:100],
                                      BSales$ad_online1[96:100],
                                      BSales$t[96:100],
                                      BSales$discount[96:100]))
ASE3 = mean((BSales$sales[96:100] - preds$pred)^2)
ASE3

plot(seq(1,100,1), BSales$sales[1:100], type = "l", xlim = c(0,100), 
     ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$pred, type = "l", col = "red")
```

The MLR model with lagged advertising (lag-1), trend, and discount, combined with AR(7) errors, achieves AIC=332.46 and ASE=4.93, which captures the sharp sales decline in the last five weeks.

## VAR Model 5

```{r, results='hide'}
BSales2 = BSales[1:95,]
BSVar = VAR(cbind(BSales2$sales, BSales2$ad_tv, BSales2$ad_online), 
            type = "const", lag.max = 10)
AIC(BSVar)

preds = predict(BSVar, n.ahead = 5)

ASE5 = mean((BSales$sales[96:100] - preds$fcst$y1[,1])^2)
ASE5

plot(seq(1,100,1), BSales$sales[1:100], type = "l", xlim = c(0,100), 
     ylab = "Business Sales", main = "5 Week Sales Forecast")
lines(seq(96,100,1), preds$fcst$y1[,1], type = "l", col = "red")
```

The VAR model with constant only (no trend) models all three variables simultaneously, achieving AIC=173.54 and ASE=11.59, but fails to capture the sharp sales decline.